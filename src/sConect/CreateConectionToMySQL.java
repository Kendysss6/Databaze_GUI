package sConect;

import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.io.File;
import java.io.FileInputStream;
import java.io.InputStreamReader;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.Arrays;

import javax.swing.JFileChooser;
import javax.swing.JFrame;
import javax.swing.JOptionPane;
import javax.swing.JProgressBar;
import javax.swing.SwingWorker;
import javax.swing.filechooser.FileNameExtensionFilter;

import app.LoginWindow;
import app.MainFrame;
import app.ProgresBarFrame;
import sablony.errorwin.ExceptionWin;
import thread.ObnovStrukturuDB;
import thread.ScriptRunner;

/**
 * Tøída pro vytváøení spojení mezi databází. Pomocí této tøídy získáme tøídu java.sql.Connection pro komnikaci s databází
 * @author Ondøej Havlíèek
 *
 */
public class CreateConectionToMySQL implements ActionListener {
	private final String url;
	private final String driverMysql = "com.mysql.jdbc.Driver";
	private final String driverMariaDB = "org.mariadb.jdbc.Driver";
	private final String spatneHeslo= "Access denied for user";
	private final String neniPripojeni= "Communications link failure";
	private static final String acesDenied = "execute command denied to user";
	private JFrame loginWindow;
	private ProgresBarFrame prgbarFrame;
	private Task t;
	private static final String cancelZprava = "java.util.concurrent.CancellationException";
	
	private int returnVal = -100;
	
	/**
	 * Konstruktor, vyplní se pouze údaje potøebné k pøipojení.
	 * @param okno JFrame, na který by se pøípadnì zobrazil dialog s vyvolanou vyjimkou.
	 * @param progresBar Progressbar na který budeme zobrazovat vývoj pøipojování
	 * @param url kompletní IP adresa serveru
	 */
	public CreateConectionToMySQL(JFrame okno, ProgresBarFrame progresBar, String url){
		this.url = url;
		this.loginWindow = okno;
		prgbarFrame = progresBar;
		prgbarFrame.addListener(this);
	}
	
	/**
	 * Metoda vracející odkaz na vytvoøenou aplikaci. Spuští se zde thread {@link sConect.CreateConectionToMySQL.Task Task}
	 * @param userName uživatelské jméno pro pøipojení do databáze
	 * @param pass heslo v char [] field.
	 * @return
	 */
	public void executeVytvor(String userName, char [] pass){
		t = new Task(userName, pass);
		t.execute();
	}
	
	
	/**
	 * <p>Tøída rozšiøující <a href="https://docs.oracle.com/javase/8/docs/api/javax/swing/SwingWorker.html">SwingWorker</a>,
	 *  která vytváøí celou aplikaci v pozadí, zatímco zobrazuje stav vytváøení pomocí {@link app.ProgresBarFrame}</p>
	 * <p>Trochu zbyteèná tøída, protože už tuhle tøídu vytváøim ve <a href="https://docs.oracle.com/javase/8/docs/api/javax/swing/SwingWorker.html">SwingWorker</a>,
	 * ale tak nic se nestane. Bylo by moc práce to zase pøepisovat a dávat do jednoho.</p>
	 * @author Ondøej Havlíèek
	 */
	private class Task extends SwingWorker<MainFrame, Void> {
        /*
         * Main task. Executed in background thread.
         */
		private String userName;
		private char [] pass;
		private Task(String jmeno, char [] pass){
			prgbarFrame.setVisible(true);
			this.pass = pass;
			this.userName = jmeno;
		}
		
        @Override
        public MainFrame doInBackground() {  
            prgbarFrame.setPripojuji();
        	// pripojuju
        	String password;
        	Connection conn = null;
        	try{
        		password = new String(pass);
        		Arrays.fill(pass,'0');
        		Class.forName(driverMysql).newInstance();
        		conn = DriverManager.getConnection(url,userName,password);
        		password = " ";
        		password = null;
        	} catch(Exception e){
        		if(e.getMessage().contains(spatneHeslo)){
        			prgbarFrame.setVisible(false);
        			if(!isCancelled()){
        				JOptionPane.showMessageDialog(loginWindow, "\u0160patn\u00E9 heslo nebo uživatelské jméno");
        			}
				}
				else if(e.getMessage().startsWith(neniPripojeni)) {
					prgbarFrame.setVisible(false);
					if(!isCancelled()){
						JOptionPane.showMessageDialog(loginWindow, "Není zapnutý server (nebo špatná IP adresa serveru)");
					}
				}
				else if(e.getClass().getCanonicalName().equals("java.sql.SQLNonTransientConnectionException")) {
					prgbarFrame.setVisible(false);
					if(!isCancelled()){
						JOptionPane.showMessageDialog(loginWindow, "Není zapnutý server (nebo špatná IP adresa serveru), nepøipojeno");
					}
				}
				else {
					prgbarFrame.setVisible(false);
					ExceptionWin.showExceptionMessage(e);
				}
        		if(conn != null){
        			try {
						conn.close();
					} catch (SQLException e1) {
						ExceptionWin.showExceptionMessage(e1);
					}
        			conn = null;
        		}
        		return null;
        	} finally{
        		password = " ";
        		password = null;
        		System.gc();
        	}
        	//vytvarim aplikaci
        	prgbarFrame.setVytvarimAplikaci();
        	
        	MainFrame hlavniOkno = null;
        	try{
        		if(isNewestVersionGUI(conn.prepareCall("{CALL pomdb.verze()}").executeQuery())){
        			hlavniOkno = new MainFrame(conn, userName, prgbarFrame.getApProgresBar());
        		} else {
        			prgbarFrame.setVisible(false);
        			JOptionPane.showMessageDialog(loginWindow, "Nemáte nejnovìjší verzi aplikace Databáze Strašice, nelze spustit.");
        		}
        	} catch (SQLException e){
        		prgbarFrame.setVisible(false);
        		prgbarFrame.setZalohaDB();
        		if(e.getMessage().startsWith(acesDenied)){        			
        			JOptionPane.showMessageDialog(loginWindow, "Chybí vám pravomoce. Kontaktuje prosím administrátora.");
				} else {
					//ExceptionWin.showExceptionMessage(e);
					e.printStackTrace();
					JOptionPane.showMessageDialog(loginWindow, "Objevila se chyba pøi vytváøení GUI, CreateConection -doInBackground(), pokud chcete obnovit databázi vyberte soubor strukturaDB.sql");
					File curDirectory = new File("./");
					File obnovDBSqlFile = null;
					JFileChooser chooser = new JFileChooser(curDirectory);
					FileNameExtensionFilter filter = new FileNameExtensionFilter("Soubor SQL", "sql");
					chooser.setFileFilter(filter);
					chooser.setDialogTitle("Vyberte soubor strukturaDB.sql");
					returnVal = chooser.showOpenDialog(loginWindow);
					if(returnVal == JFileChooser.APPROVE_OPTION) {
						prgbarFrame.setVisible(true);
						obnovaStrukturyDB(conn, chooser.getSelectedFile());
					}
				}
				
        	}
        	
        	if(returnVal != 0){
        		prgbarFrame.setHotovo();
        	}
        	
        	return hlavniOkno;
        }
        private void obnovaStrukturyDB(Connection conn, File obnovDBSqlFile){
        	prgbarFrame.setVisible(true);
        	ObnovStrukturuDB obnov = new ObnovStrukturuDB(loginWindow, prgbarFrame, conn, obnovDBSqlFile);
        	obnov.execute();
    	}
       

        /*
         * Executed in event dispatching thread
         */
        @Override
        public void done() {
        	if(returnVal != 0 ){
        		prgbarFrame.setVisible(false);
        		prgbarFrame.dispose();
        	}
        	
        	
        	MainFrame okno = null;
        	try {
    			okno = t.get();
    		} catch (Exception e) {			
    			if (cancelZprava.startsWith(e.toString())) {
    				JOptionPane.showMessageDialog(loginWindow, "Pøipojování pøerušeno");
    			} else {
    				ExceptionWin.showExceptionMessage(e);
    			}
    			
    		}
        	if(okno != null){
        		okno.setVisible(true);
        		loginWindow.setVisible(false);
        		loginWindow.dispose();
        	}
        }
    }
	/**
	 * Obsluha pro {@code CancelButton} v {@link app.ProgresBarFrame}
	 */
	@Override
	public void actionPerformed(ActionEvent e) {
		if(e.getActionCommand().equalsIgnoreCase("Cancel")){
			boolean pom = t.cancel(true);
			System.out.println("preruseno "+pom );
			if(!pom){
				JOptionPane.showMessageDialog(loginWindow, "Aplikace je již vytoøena");
			}
		}
		
	}
	
	private boolean isNewestVersionGUI(ResultSet rs) throws SQLException{
		if(rs.first()){
			String verze = rs.getString(1);
			String appVer = LoginWindow.verzeGUI;
			// kontrolujeme prvni tøi pismena
			for(int i = 0; i < 3; i++){
				if (verze.charAt(i) != appVer.charAt(i)){
					return false;
				}
			}
			return true;
		}
		return false;
	}
}
